<!DOCTYPE html>
<html lang="uz">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Yechish</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            border: 1px solid grey;
            padding: 3px;
            margin: 3px;
        }

        .question {
            display: none;
        }

        .question.active {
            display: block;
        }

        #resultChart {
            max-width: 600px;
            margin: 20px auto;
        }
    </style>
</head>

<body>

    <div class="container py-3" id="quiz-content">
        <h2 class="text-center mb-4">Test Yechish</h2>
        <form id="quizForm">

        </form>
        <div class="text-center">
            <button class="btn btn-primary mt-3 btn-sm" id="previousBtn" onclick="previousQuestion()"
                disabled>Oldingi</button>
            <button class="btn btn-primary mt-3 btn-sm" id="nextBtn" onclick="nextQuestion()">Keyingi</button>
            <button class="btn btn-success mt-3 btn-sm" id="submitBtn" onclick="submitQuiz()"
                style="display:none;">Natijani ko'rsatish</button>
        </div>
    </div>

    <div id="resultContainer" class="text-center" style="display: none;">
        <h3 id="resultText"></h3>
        <canvas id="resultChart"></canvas>
        <button id="downloadBtn" class="btn btn-success btn-sm mt-3" onclick="downloadResults()">Natijani yuklab
            olish</button>
        <a class="btn btn-info btn-sm m-3" id="back" href="/">Qaytish</a>
    </div>

    <script>
        document.getElementById('back').style.display = "none";
        let quizData = [];
        let currentQuestion = 0;

        // JSON fayldan savollarni yuklash
        async function loadQuizData() {
            try {
                const response = await fetch('../tests/1.json'); // 1.json fayldan ma'lumotlarni yuklash
                quizData = await response.json();
                loadQuiz();
            } catch (error) {
                console.error("JSON fayl yuklanishda xatolik: ", error);
            }
        }

        // Savollarni sahifaga yuklash
        function loadQuiz() {
            const quizForm = document.getElementById('quizForm');
            quizData.forEach((item, index) => {
                const questionBlock = document.createElement('div');
                questionBlock.classList.add('question');
                if (index === 0) questionBlock.classList.add('active');
                questionBlock.setAttribute('id', `question${index}`);
                questionBlock.innerHTML = `
                    <h5>${item.savol}</h5>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${index + 1}" value="a" id="q${index + 1}a">
                        <label class="form-check-label" for="q${index + 1}a">${item.javoblar.a}</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${index + 1}" value="b" id="q${index + 1}b">
                        <label class="form-check-label" for="q${index + 1}b">${item.javoblar.b}</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${index + 1}" value="v" id="q${index + 1}v">
                        <label class="form-check-label" for="q${index + 1}v">${item.javoblar.v}</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="q${index + 1}" value="g" id="q${index + 1}g">
                        <label class="form-check-label" for="q${index + 1}g">${item.javoblar.g}</label>
                    </div>
                `;
                quizForm.appendChild(questionBlock);
            });
        }

        // Oldingi savolga o'tish
        function previousQuestion() {
            if (currentQuestion > 0) {
                toggleQuestion(currentQuestion, currentQuestion - 1);
                currentQuestion--;
                updateButtons();
            }
        }

        // Keyingi savolga o'tish
        function nextQuestion() {
            if (currentQuestion < quizData.length - 1) {
                toggleQuestion(currentQuestion, currentQuestion + 1);
                currentQuestion++;
                updateButtons();
            }
        }

        // Savollarni o'zgarishi
        function toggleQuestion(hideIndex, showIndex) {
            document.getElementById(`question${hideIndex}`).classList.remove('active');
            document.getElementById(`question${showIndex}`).classList.add('active');
        }

        // Tugmalarni yangilash
        function updateButtons() {
            document.getElementById('previousBtn').disabled = currentQuestion === 0;
            document.getElementById('nextBtn').style.display = currentQuestion === quizData.length - 1 ? 'none' :
                'inline-block';
            document.getElementById('submitBtn').style.display = currentQuestion === quizData.length - 1 ?
                'inline-block' : 'none';
        }

        // Test natijalarini hisoblash
        function submitQuiz() {
            document.getElementById('quiz-content').style.display = "none";
            document.getElementById('resultContainer').style.display = "block";
            document.getElementById('back').style.display = "block";
            let correctAnswers = 0;
            quizData.forEach((item, index) => {
                const selectedAnswer = document.querySelector(`input[name="q${index + 1}"]:checked`);
                if (selectedAnswer && selectedAnswer.value === item.togri_javob) {
                    correctAnswers++;
                }
            });
            showResults(correctAnswers, quizData.length);
        }

        // Natijalarni grafikda chiqarish
        function showResults(correctAnswers, totalQuestions) {
            const ctx = document.getElementById('resultChart').getContext('2d');
            const percentage = Math.round((correctAnswers / totalQuestions) * 100);
            const wrongAnswers = totalQuestions - correctAnswers;

            // Natijalarni matn ko'rinishida ko'rsatish
            document.getElementById('resultText').innerText =
                `To'g'ri javoblar: ${correctAnswers} / ${totalQuestions} (${percentage}%)`;

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['To`g`ri', 'Noto`g`ri'],
                    datasets: [{
                        label: 'Test natijalari',
                        data: [correctAnswers, wrongAnswers],
                        backgroundColor: ['#4CAF50', '#F44336']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function (tooltipItem) {
                                    return `${tooltipItem.label}: ${tooltipItem.raw}`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function stringToHash(string) {
            return string.split('').reduce((hash, char) => {
                return char.charCodeAt(0) + (hash << 6) + (hash << 16) - hash;
            }, 0);
        }

        // Natijalarni yuklash
        function downloadResults() {
            const correctAnswers = document.getElementById('resultText').innerText;
            const blob = new Blob([correctAnswers], {
                type: 'text/plain'
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = stringToHash(Date()) + '.txt';
            link.click();
        }

        // Sahifani yuklaganda savollarni yuklash
        window.onload = loadQuizData;
    </script>

</body>

</html>